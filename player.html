<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BGM Player</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 16px; }
    #toggle {
      font-size: 30px;           /* ê¸€ì í¬ê¸° */
      padding: 20px 28px;        /* ë²„íŠ¼ ì•ˆìª½ ì—¬ë°±(ì„¸ë¡œ, ê°€ë¡œ) */
      border-radius: 30px;       /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸° */
      border: 50;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    .hint { margin-top: 20px; opacity: .5; font-size: 18px; }
  </style>
</head>
<body>

  <button id="toggle">â–¶ï¸ Music Play ğŸ§</button>
  <div class="hint">Click to Play</div>

  <audio id="bgm" loop preload="none">
    <source src="assets/audio/bgm.mp3" type="audio/mpeg">
  </audio>

  <script>
  (function () {
    // =========================
    // 1) ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ë½(ì¤‘ë³µ ì°½ ìë™ ì¢…ë£Œ)
    // =========================
    const TAB_ID = sessionStorage.getItem('BGM_TAB_ID') || (Math.random().toString(36).slice(2));
    sessionStorage.setItem('BGM_TAB_ID', TAB_ID);

    const LOCK_KEY = 'BGM_PLAYER_LOCK';
    const HEARTBEAT_MS = 800;
    const STALE_MS = 2500;

    function now() { return Date.now(); }

    function readLock() {
      try { return JSON.parse(localStorage.getItem(LOCK_KEY) || 'null'); }
      catch { return null; }
    }

    function writeLock(obj) {
      localStorage.setItem(LOCK_KEY, JSON.stringify(obj));
    }

    // ê¸°ì¡´ ë½ì´ ì‚´ì•„ìˆìœ¼ë©´(ìµœê·¼ heartbeat) -> ì´ ì°½ì€ ì¤‘ë³µì´ë¯€ë¡œ ë‹«ëŠ”ë‹¤.
    const lock = readLock();
    if (lock && lock.id && lock.id !== TAB_ID && (now() - lock.ts) < STALE_MS) {
      // ì¤‘ë³µ ì°½: ìë™ ì¢…ë£Œ
      window.close();
      // window.closeê°€ ë§‰íˆëŠ” í™˜ê²½ì´ë©´, ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë¬¸êµ¬ë¼ë„ ë³´ì—¬ì£¼ê³  ì¬ìƒ ì•ˆ í•˜ê²Œ ë§‰ëŠ”ë‹¤.
      document.body.innerHTML = '<p style="font-family:system-ui; padding:16px;">ì´ë¯¸ í”Œë ˆì´ì–´ê°€ ì—´ë ¤ ìˆì–´ ì´ ì°½ì€ ì¤‘ë³µì…ë‹ˆë‹¤. ì´ íƒ­ì„ ë‹«ì•„ì£¼ì„¸ìš”.</p>';
      return;
    }

    // ë‚´ê°€ ë¦¬ë”ê°€ ë¨
    writeLock({ id: TAB_ID, ts: now() });

    // heartbeatë¡œ ë½ ê°±ì‹ 
    const hb = setInterval(() => {
      const cur = readLock();
      // ë‹¤ë¥¸ íƒ­ì´ ë½ì„ ê°€ì ¸ê°”ìœ¼ë©´(ë‚´ê°€ ë¦¬ë” ì•„ë‹˜) -> ì¬ìƒ ë©ˆì¶”ê³  ì¢…ë£Œ
      if (cur && cur.id && cur.id !== TAB_ID && (now() - cur.ts) < STALE_MS) {
        clearInterval(hb);
        try { audio.pause(); } catch {}
        window.close();
        return;
      }
      writeLock({ id: TAB_ID, ts: now() });
    }, HEARTBEAT_MS);

    window.addEventListener('beforeunload', () => {
      const cur = readLock();
      if (cur && cur.id === TAB_ID) localStorage.removeItem(LOCK_KEY);
    });

    // =========================
    // 2) ì¬ìƒ ë¡œì§
    // =========================
    const btn = document.getElementById('toggle');
    const audio = document.getElementById('bgm');
    let playing = false;

    async function playMusic() {
      if (playing) return; // ì´ë¯¸ ì¬ìƒ ì¤‘ì´ë©´ ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
      await audio.play();
      playing = true;
      btn.textContent = 'âšâš';
    }

    function pauseMusic() {
      if (!playing) return;
      audio.pause();
      playing = false;
      btn.textContent = 'â–¶ï¸';
    }

    btn.addEventListener('click', async () => {
      try {
        if (!playing) await playMusic();
        else pauseMusic();
      } catch (e) {
        console.log(e);
      }
    });

    // =========================
    // 3) ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì˜¤ëŠ” ëª…ë ¹ ìˆ˜ì‹ (postMessage)
    // =========================
    window.addEventListener('message', async (e) => {
      try {
        if (e.data === 'PLAY') await playMusic();
        if (e.data === 'PAUSE') pauseMusic();
      } catch (err) {
        console.log(err);
      }
    });

  })();
  </script>
</body>
</html>